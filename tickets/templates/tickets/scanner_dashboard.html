{% extends 'tickets/base.html' %}

{% block title %}Scanner Dashboard{% endblock %}

{% block extra_css %}
<style>
    #reader {
        border: 3px solid #667eea;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .ticket-info-card {
        display: none;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .success-animation {
        animation: pulse 0.5s ease-in-out;
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-qr-code-scan text-primary" style="font-size: 3rem;"></i>
                    <h1 class="h3 mt-3 fw-bold">QR Code Scanner</h1>
                    <p class="text-muted">Biletleri taramak için kamerayı QR koda tutun</p>
                </div>
                
                <div id="reader" class="mb-4"></div>
                
                <div id="ticketInfo" class="ticket-info-card">
                    <div class="alert" id="statusAlert" role="alert"></div>
                    
                    <div id="ticketDetails" class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Bilet Bilgileri</h5>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-calendar-event text-primary"></i> Etkinlik:</strong>
                                    <p id="eventName" class="mb-0"></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-calendar3 text-primary"></i> Tarih:</strong>
                                    <p id="eventDate" class="mb-0"></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-geo-alt text-primary"></i> Konum:</strong>
                                    <p id="eventLocation" class="mb-0"></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-person text-primary"></i> İsim:</strong>
                                    <p id="attendeeName" class="mb-0"></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-people text-primary"></i> +1:</strong>
                                    <p id="plusOnes" class="mb-0"></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <strong><i class="bi bi-hash text-primary"></i> Toplam Kişi:</strong>
                                    <p id="totalAttendees" class="mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button id="resetBtn" class="btn btn-secondary" style="display: none;">
                        <i class="bi bi-arrow-clockwise"></i> Yeni Tarama
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    let html5QrCode;
    let isProcessing = false;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return;
        isProcessing = true;
        
        // Stop scanning
        html5QrCode.pause();
        
        // Validate ticket
        validateTicket(decodedText);
    }
    
    function validateTicket(ticketUuid) {
        const csrftoken = getCookie('csrftoken');
        
        fetch('{% url "validate_ticket" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `ticket_uuid=${ticketUuid}`
        })
        .then(response => response.json())
        .then(data => {
            displayTicketInfo(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Bir hata oluştu. Lütfen tekrar deneyin.');
            isProcessing = false;
            html5QrCode.resume();
        });
    }
    
    function displayTicketInfo(data) {
        const ticketInfo = document.getElementById('ticketInfo');
        const statusAlert = document.getElementById('statusAlert');
        const resetBtn = document.getElementById('resetBtn');
        
        ticketInfo.style.display = 'block';
        ticketInfo.classList.add('success-animation');
        resetBtn.style.display = 'inline-block';
        
        if (data.success) {
            statusAlert.className = 'alert alert-success';
            statusAlert.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${data.message}</strong>`;
            
            document.getElementById('eventName').textContent = data.ticket.event_name;
            document.getElementById('eventDate').textContent = data.ticket.event_date;
            document.getElementById('eventLocation').textContent = data.ticket.event_location;
            document.getElementById('attendeeName').textContent = data.ticket.attendee_name;
            document.getElementById('plusOnes').textContent = data.ticket.plus_ones;
            document.getElementById('totalAttendees').textContent = data.ticket.total_attendees;
            
            document.getElementById('ticketDetails').style.display = 'block';
        } else {
            statusAlert.className = 'alert alert-danger';
            statusAlert.innerHTML = `<i class="bi bi-x-circle"></i> <strong>${data.message}</strong>`;
            
            if (data.ticket) {
                document.getElementById('eventName').textContent = data.ticket.event_name;
                document.getElementById('attendeeName').textContent = data.ticket.attendee_name;
                document.getElementById('plusOnes').textContent = data.ticket.plus_ones;
                document.getElementById('ticketDetails').style.display = 'block';
            } else {
                document.getElementById('ticketDetails').style.display = 'none';
            }
        }
    }
    
    function showError(message) {
        const ticketInfo = document.getElementById('ticketInfo');
        const statusAlert = document.getElementById('statusAlert');
        
        ticketInfo.style.display = 'block';
        statusAlert.className = 'alert alert-danger';
        statusAlert.innerHTML = `<i class="bi bi-x-circle"></i> <strong>${message}</strong>`;
        document.getElementById('ticketDetails').style.display = 'none';
    }
    
    function resetScanner() {
        document.getElementById('ticketInfo').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        isProcessing = false;
        html5QrCode.resume();
    }
    
    // Initialize scanner
    document.addEventListener('DOMContentLoaded', function() {
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 }
        };
        
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess
        ).catch(err => {
            console.error('Unable to start scanning', err);
            showError('Kamera erişimi reddedildi veya kullanılamıyor.');
        });
        
        document.getElementById('resetBtn').addEventListener('click', resetScanner);
    });
</script>
{% endblock %}

